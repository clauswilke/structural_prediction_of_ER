! THIS PROGRAM TAKES IN THE OUTPUT FILES *.wcn GENERATED BY PROGRAM dynamic_wcn.f90 and summarizes the results in the form of mean and variance WCN (Weighted Contact Number).
! AMIR SHAHMORADI, Friday 1:26 PM, Nov 22, 2013, ICMB, UT AUSTIN

!module aa_dictionary
!	implicit none
!	integer, parameter :: aa_num = 20
!	character(len=1), dimension(aa_num) :: aa_dict = ['A','R','N','D','C','Q','E','G','H','I','L','K','M','F','P','S','T','W','Y','V']
!	real*8, dimension(aa_num) :: max_rsa = [129.,274.,195.,193.,167.,225.,223.,104.,224.,197.,201.,236.,224.,240.,159.,155.,172.,285.,263.,174.]
!end module aa_dictionary

program wcn_summarizer
implicit none
integer :: i,j,nres,ntraj=-3,ios,idummy
integer :: nitems	! function
real*8, dimension(:,:), allocatable :: wcn
integer, dimension(:), allocatable :: res_num
character(len=2), dimension(:), allocatable :: chain_id
character(len=3), dimension(:), allocatable :: res_name
CHARACTER(LEN=300) :: wcn_in				! wcn file generated by dynamic_wcn.f90.
!CHARACTER(LEN=300) :: rsa_out			! RSA file containing the normalized wcn values.
CHARACTER(LEN=300) :: wcn_sum			! RSA summary file (containing the average, median, stdev).
character(len=15000) :: line
character(len=15) :: dummy_char
character(len=100) :: wcn_output_format,res_output_format,resnum_output_format
real*8 :: MRSA_finder,select	! functions
real*8 :: max_rsa,mean_wcn,med_wcn,stdev_rsa,var_wcn,var2mean

if (command_argument_count()/=2) then
	write(*,*)
	write(*,*) "Incorrect number of input arguments on the command line."
	write(*,*) "Correct use:"
	write(*,*) "./a.out <input wcn file> <output wcn summary file>"
	write(*,*)
	stop
end if
call get_command_argument(1,wcn_in)
call get_command_argument(2,wcn_sum)
!call get_command_argument(3,rsa_sum)

! NOW DETERMINE THE NUMBER OF COLUMNS AND LINES IN THE INPUT wcn FILE. 
	open(unit=11,file=trim(adjustl(wcn_in)),status='old')
	read(11,'(1A15000)') line
	nres = nitems(line)-1
	write(*,*) '# of residues in wcn file: ',nres
	do
		read(11,'(1A15000)',iostat=ios) line
		if (ios<0) then
			exit
		elseif (ios>0) then
			write(*,*) 'Sum Tin Wong! : PDB file broken.'; stop
		else
			ntraj = ntraj + 1
		end if
		cycle
	end do
	write(*,*) '# of MD trajectories in wcn file: ',ntraj
	close(11)

open(unit=11,file=trim(adjustl(wcn_in)),status='old')
open(unit=22,file=trim(adjustl(wcn_sum)),status='replace')
	
allocate(wcn(0:ntraj,nres),res_num(nres),res_name(nres),chain_id(nres))

! NOW PREPARE THE wcn OUTPUT FILE.
	write(dummy_char,*) nres
	wcn_output_format = trim(adjustl('(1I15,' // trim(adjustl(dummy_char)) // 'E15.5)'))
	resnum_output_format = trim(adjustl('(1A15,' // trim(adjustl(dummy_char)) // 'I15)'))
	res_output_format = trim(adjustl('(1A15,' // trim(adjustl(dummy_char)) // 'A15)'))

! NOW READ THE HEADER OF THE INPUT FILE
	read(11,res_output_format) dummy_char,res_name(1:nres)
	read(11,resnum_output_format) dummy_char,res_num(1:nres)
	read(11,res_output_format) dummy_char,chain_id(1:nres)

! NOW READ THE wcn VALUES.
	do i = 0,ntraj
		read(11,wcn_output_format) idummy,wcn(i,1:nres)
		if (idummy/=i) then; write(*,*) 'idummy /= i : ', idummy, i; stop; end if
	end do

! NOW WRITE OUT THE RSA SUMMARY FILE.
	write(22,'(8A15)') 'AMINO_ACID','RES_NUM','CHAIN','CRYSTAL_WCN','MEAN_WCN','MEDIAN_WCN','VAR_WCN','VAR2MEAN_WCN'
	do i = 1,nres
		call avevar(wcn(1:ntraj,i),ntraj,mean_wcn,var_wcn)
		var2mean = var_wcn/mean_wcn
		!stdev_rsa = sqrt(var_wcn)
		!write(*,*) mean_rsa_dummy
		!write(*,*) mean_wcn
		med_wcn = select(ntraj/2,ntraj,wcn(1:ntraj,i))
		write(22,'(1A15,1I15,1A15,5E15.5)') res_name(i),res_num(i),chain_id(i),wcn(0,i),mean_wcn,med_wcn,var_wcn,var2mean
	end do

end program wcn_summarizer

include 'func_nitems.f90'
!include 'func_MRSA_finder.f90'
include 'func_select.f90'
include 'sub_avevar.f90'



